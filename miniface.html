<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexo ‚Äî Tu red social</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #f5f0e8;
      --dark: #1a1612;
      --ink: #2d2820;
      --accent: #c8502a;
      --accent2: #e8a87c;
      --gold: #d4a853;
      --paper: #faf7f2;
      --muted: #8c8277;
      --border: #e0d9ce;
      --card-shadow: 0 2px 16px rgba(26,22,18,0.08), 0 1px 4px rgba(26,22,18,0.04);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--cream);
      color: var(--ink);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: var(--dark);
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 2px solid var(--accent);
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--cream);
      letter-spacing: -1px;
    }
    .logo span { color: var(--accent); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-avatar {
      width: 38px; height: 38px;
      border-radius: 50%;
      background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    .post-count-badge {
      background: var(--accent);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .main-layout {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1rem;
      display: grid;
      grid-template-columns: 1fr 520px 1fr;
      gap: 2rem;
    }

    @media (max-width: 900px) {
      .main-layout { grid-template-columns: 1fr; }
      .sidebar-left, .sidebar-right { display: none; }
    }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar-left, .sidebar-right {
      padding-top: 1rem;
    }

    .sidebar-section {
      background: var(--paper);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }

    .sidebar-title {
      font-family: 'Playfair Display', serif;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 0.75rem;
    }

    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .sidebar-avatar {
      width: 52px; height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--gold));
      display: flex; align-items: center; justify-content: center;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      color: white;
      font-size: 1.3rem;
    }

    .sidebar-username {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .sidebar-handle {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-top: 1px solid var(--border);
      font-size: 0.875rem;
    }

    .stat-val {
      font-weight: 600;
      color: var(--accent);
    }

    /* ‚îÄ‚îÄ FEED CENTER ‚îÄ‚îÄ */
    .feed {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    /* ‚îÄ‚îÄ COMPOSER ‚îÄ‚îÄ */
    .composer {
      background: var(--paper);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
    }

    .composer-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .composer-avatar {
      width: 42px; height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--gold));
      display: flex; align-items: center; justify-content: center;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      color: white;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .composer-prompt {
      color: var(--muted);
      font-size: 0.95rem;
      cursor: pointer;
    }

    .composer-textarea {
      width: 100%;
      min-height: 90px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      padding: 0.85rem 1rem;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      color: var(--ink);
      background: var(--cream);
      resize: vertical;
      transition: border-color 0.2s;
      outline: none;
    }

    .composer-textarea:focus {
      border-color: var(--accent);
    }

    .composer-textarea::placeholder { color: var(--muted); }

    /* Image upload zone */
    .image-zone {
      margin: 0.75rem 0;
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 1.25rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .image-zone:hover, .image-zone.drag-over {
      border-color: var(--accent);
      background: rgba(200, 80, 42, 0.04);
    }

    .image-zone input[type="file"] {
      position: absolute; inset: 0;
      opacity: 0; cursor: pointer;
      width: 100%; height: 100%;
    }

    .image-zone-icon { font-size: 1.5rem; margin-bottom: 0.3rem; }
    .image-zone-text { font-size: 0.85rem; color: var(--muted); }

    .image-preview-wrap {
      position: relative;
      margin: 0.75rem 0;
    }

    .image-preview {
      width: 100%;
      max-height: 260px;
      object-fit: cover;
      border-radius: 10px;
      display: block;
    }

    .remove-img-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: rgba(26,22,18,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px; height: 28px;
      font-size: 1rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }

    .remove-img-btn:hover { background: var(--accent); }

    .composer-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.75rem;
      gap: 0.5rem;
    }

    .composer-actions {
      display: flex;
      gap: 0.5rem;
    }

    .icon-btn {
      background: none;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 0.45rem 0.75rem;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--muted);
      display: flex; align-items: center; gap: 0.35rem;
      transition: all 0.15s;
      font-family: 'DM Sans', sans-serif;
    }

    .icon-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .post-btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.55rem 1.4rem;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.3px;
    }

    .post-btn:hover { background: #b04320; transform: translateY(-1px); }
    .post-btn:disabled { background: var(--muted); cursor: not-allowed; transform: none; }

    /* ‚îÄ‚îÄ POSTS ‚îÄ‚îÄ */
    .post-card {
      background: var(--paper);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
      animation: fadeUp 0.3s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
    }

    .post-avatar {
      width: 42px; height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--gold));
      display: flex; align-items: center; justify-content: center;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      color: white;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .post-meta { flex: 1; }

    .post-author {
      font-family: 'Playfair Display', serif;
      font-size: 1rem;
      font-weight: 700;
      color: var(--ink);
    }

    .post-time {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 1px;
    }

    .post-menu-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 1.2rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: background 0.15s;
    }

    .post-menu-btn:hover { background: var(--border); }

    .post-body {
      padding: 0 1.25rem 0.75rem;
    }

    .post-text {
      font-size: 0.95rem;
      line-height: 1.65;
      color: var(--ink);
      white-space: pre-wrap;
    }

    .post-image {
      width: 100%;
      max-height: 420px;
      object-fit: cover;
      display: block;
      margin-top: 0.75rem;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .post-image:hover { opacity: 0.95; }

    .post-actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.6rem 1rem;
      border-top: 1px solid var(--border);
      margin-top: 0.5rem;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.45rem 0.75rem;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 500;
      transition: all 0.15s;
    }

    .action-btn:hover { background: var(--cream); color: var(--ink); }

    .action-btn.liked {
      color: var(--accent);
    }

    .action-btn.liked svg path { fill: var(--accent); }

    .like-count { font-weight: 600; }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 3rem 1.5rem;
      color: var(--muted);
    }

    .empty-icon { font-size: 3rem; margin-bottom: 0.75rem; }

    .empty-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      color: var(--ink);
      margin-bottom: 0.5rem;
    }

    /* ‚îÄ‚îÄ IMAGE MODAL ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(26,22,18,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }

    .modal-img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .modal-close {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      background: white;
      border: none;
      border-radius: 50%;
      width: 40px; height: 40px;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    /* ‚îÄ‚îÄ DROPDOWN MENU ‚îÄ‚îÄ */
    .post-menu-wrap { position: relative; }

    .dropdown-menu {
      position: absolute;
      right: 0; top: 100%;
      background: var(--paper);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.4rem;
      min-width: 140px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      z-index: 50;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 7px;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--ink);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: 'DM Sans', sans-serif;
    }

    .dropdown-item:hover { background: var(--cream); }
    .dropdown-item.danger:hover { background: #fde8e3; color: var(--accent); }

    /* ‚îÄ‚îÄ DB INFO BOX ‚îÄ‚îÄ */
    .db-info {
      background: linear-gradient(135deg, #1a1612, #2d2820);
      border-radius: 12px;
      padding: 1.25rem;
      color: var(--cream);
      font-size: 0.82rem;
      line-height: 1.6;
    }

    .db-info-title {
      font-family: 'Playfair Display', serif;
      font-size: 0.9rem;
      color: var(--gold);
      margin-bottom: 0.6rem;
      font-weight: 700;
    }

    .db-info code {
      background: rgba(255,255,255,0.1);
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 0.78rem;
      color: var(--accent2);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Notification toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(0);
      background: var(--dark);
      color: var(--cream);
      padding: 0.7rem 1.5rem;
      border-radius: 40px;
      font-size: 0.875rem;
      font-weight: 500;
      z-index: 9999;
      animation: toastAnim 2.5s ease forwards;
      border-left: 3px solid var(--accent);
    }

    @keyframes toastAnim {
      0%   { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15%  { opacity: 1; transform: translateX(-50%) translateY(0); }
      75%  { opacity: 1; }
      100% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">Ne<span>x</span>o</div>
  <div class="header-right">
    <span class="post-count-badge" id="headerCount">0 posts</span>
    <div class="header-avatar" title="Tu perfil">T</div>
  </div>
</header>

<!-- LAYOUT -->
<div class="main-layout">

  <!-- SIDEBAR IZQUIERDA -->
  <aside class="sidebar-left">
    <div class="sidebar-section">
      <div class="sidebar-user">
        <div class="sidebar-avatar">T</div>
        <div>
          <div class="sidebar-username">Tu Nombre</div>
          <div class="sidebar-handle">@tunombre</div>
        </div>
      </div>
      <div class="stat-row">
        <span>Publicaciones</span>
        <span class="stat-val" id="statPosts">0</span>
      </div>
      <div class="stat-row">
        <span>Con imagen</span>
        <span class="stat-val" id="statWithImg">0</span>
      </div>
      <div class="stat-row">
        <span>Likes dados</span>
        <span class="stat-val" id="statLikes">0</span>
      </div>
    </div>

    <div class="sidebar-section db-info">
      <div class="db-info-title">üîê Conexi√≥n al backend</div>
      <p style="margin-bottom:0.75rem">Inicia sesi√≥n para publicar con tu API de FastAPI.</p>
      <input id="authEmail" type="email" placeholder="Email" style="width:100%;margin-bottom:0.5rem;padding:0.45rem;border:1px solid var(--border);border-radius:8px;background:white" />
      <input id="authUsername" type="text" placeholder="Username (solo registro)" style="width:100%;margin-bottom:0.5rem;padding:0.45rem;border:1px solid var(--border);border-radius:8px;background:white" />
      <input id="authPassword" type="password" placeholder="Password" style="width:100%;margin-bottom:0.5rem;padding:0.45rem;border:1px solid var(--border);border-radius:8px;background:white" />
      <div style="display:flex; gap:0.4rem; flex-wrap:wrap">
        <button class="icon-btn" onclick="login()">Entrar</button>
        <button class="icon-btn" onclick="register()">Registro</button>
        <button class="icon-btn" onclick="logout()">Salir</button>
      </div>
      <p id="authStatus" style="margin-top:0.75rem;font-size:0.8rem;color:var(--muted)">No autenticado</p>
    </div>
  </aside>

  <!-- FEED CENTRAL -->
  <main>
    <div class="feed">
      <!-- COMPOSITOR -->
      <div class="composer">
        <div class="composer-header">
          <div class="composer-avatar">T</div>
          <div class="composer-prompt">¬øQu√© est√°s pensando?</div>
        </div>

        <textarea
          class="composer-textarea"
          id="postText"
          placeholder="Comparte algo con tu comunidad..."
          maxlength="2000"
        ></textarea>

        <div id="imageUploadZone" class="image-zone">
          <input type="file" id="imageInput" accept="image/*" />
          <div class="image-zone-icon">üì∑</div>
          <div class="image-zone-text">Arrastra una imagen o haz clic para seleccionar</div>
        </div>

        <div id="imagePreviewWrap" class="image-preview-wrap" style="display:none">
          <img id="imagePreview" class="image-preview" alt="Vista previa" />
          <button class="remove-img-btn" onclick="removeImage()" title="Eliminar imagen">‚úï</button>
        </div>

        <div class="composer-footer">
          <div class="composer-actions">
            <button class="icon-btn" onclick="document.getElementById('imageInput').click()">
              üñºÔ∏è Foto
            </button>
          </div>
          <button class="post-btn" id="postBtn" onclick="createPost()">Publicar</button>
        </div>
      </div>

      <!-- FEED DE POSTS -->
      <div id="feed"></div>
    </div>
  </main>

  <!-- SIDEBAR DERECHA -->
  <aside class="sidebar-right">
    <div class="sidebar-section">
      <div class="sidebar-title">Tendencias</div>
      <div style="font-size:0.875rem; color:var(--muted); line-height:1.8">
        <div>#dise√±o</div>
        <div>#tecnolog√≠a</div>
        <div>#fotograf√≠a</div>
        <div>#arte</div>
        <div>#viajes</div>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Sugerencias</div>
      <div style="font-size:0.875rem; color:var(--muted)">
        Conecta tu backend para mostrar usuarios sugeridos
      </div>
    </div>
  </aside>
</div>

<!-- MODAL IMAGEN -->
<div id="imgModal" class="modal-overlay" style="display:none" onclick="closeModal()">
  <img id="modalImg" class="modal-img" alt="Imagen ampliada" onclick="event.stopPropagation()" />
  <button class="modal-close" onclick="closeModal()">‚úï</button>
</div>

<script>
  const TOKEN_KEY = 'nexo_token_v1';
  const LIKES_KEY = 'nexo_likes_v1';

  let posts = [];
  let likes = loadLikes();
  let currentImageData = null;
  let currentUser = null;
  let openMenuId = null;

  const imageInput = document.getElementById('imageInput');
  const imagePreview = document.getElementById('imagePreview');
  const imagePreviewWrap = document.getElementById('imagePreviewWrap');
  const imageUploadZone = document.getElementById('imageUploadZone');

  imageInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) handleImageFile(file);
  });

  imageUploadZone.addEventListener('dragover', e => {
    e.preventDefault();
    imageUploadZone.classList.add('drag-over');
  });

  imageUploadZone.addEventListener('dragleave', () => imageUploadZone.classList.remove('drag-over'));
  imageUploadZone.addEventListener('drop', e => {
    e.preventDefault();
    imageUploadZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) handleImageFile(file);
  });

  function loadLikes() {
    try { return JSON.parse(localStorage.getItem(LIKES_KEY) || '{}'); } catch { return {}; }
  }
  function saveLikes() { localStorage.setItem(LIKES_KEY, JSON.stringify(likes)); }
  function getToken() { return localStorage.getItem(TOKEN_KEY); }

  async function api(path, options = {}) {
    const headers = new Headers(options.headers || {});
    const token = getToken();
    if (token) headers.set('Authorization', `Bearer ${token}`);
    const res = await fetch(path, { ...options, headers });
    if (!res.ok) {
      let detail = `Error ${res.status}`;
      try { const data = await res.json(); detail = data.detail || detail; } catch {}
      throw new Error(detail);
    }
    if (res.status === 204) return null;
    return res.json();
  }

  async function refreshPosts() {
    const data = await api('/api/posts');
    posts = data.map(p => ({
      id: p.id,
      author: (currentUser && currentUser.id === p.owner_id) ? currentUser.username : `Usuario #${p.owner_id}`,
      text: p.content,
      image: p.image_url,
      timestamp: p.created_at,
      likes: Number(likes[p.id] || 0),
      owner_id: p.owner_id
    }));
    renderFeed();
    updateStats();
  }

  async function createPost() {
    const text = document.getElementById('postText').value.trim();
    if (!text && !currentImageData && !imageInput.files[0]) return showToast('Escribe algo o adjunta una imagen');
    if (!getToken()) return showToast('Primero inicia sesi√≥n');

    const form = new FormData();
    form.append('content', text || '');
    if (imageInput.files[0]) form.append('image', imageInput.files[0]);

    try {
      await api('/api/posts', { method: 'POST', body: form });
      document.getElementById('postText').value = '';
      removeImage();
      await refreshPosts();
      showToast('¬°Post publicado! ‚úì');
    } catch (err) {
      showToast(err.message);
    }
  }

  async function deletePost(id) {
    if (!getToken()) return showToast('No autenticado');
    try {
      await api(`/api/posts/${id}`, { method: 'DELETE' });
      await refreshPosts();
      showToast('Post eliminado');
    } catch (err) {
      showToast(err.message);
    }
    closeMenus();
  }

  function toggleLike(id) {
    likes[id] = likes[id] ? 0 : 1;
    saveLikes();
    const btn = document.getElementById('likeBtn-' + id);
    const cnt = document.getElementById('likeCnt-' + id);
    if (btn) btn.className = 'action-btn' + (likes[id] ? ' liked' : '');
    if (cnt) cnt.textContent = likes[id] ? '1' : '';
    updateStats();
  }

  async function register() {
    const email = document.getElementById('authEmail').value.trim();
    const username = document.getElementById('authUsername').value.trim();
    const password = document.getElementById('authPassword').value;
    if (!email || !username || !password) return showToast('Completa email, username y password');

    try {
      await api('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, username, password })
      });
      showToast('Usuario registrado. Ahora inicia sesi√≥n.');
    } catch (err) {
      showToast(err.message);
    }
  }

  async function login() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    if (!email || !password) return showToast('Completa email y password');

    const payload = new URLSearchParams();
    payload.append('username', email);
    payload.append('password', password);

    try {
      const data = await api('/api/auth/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
      localStorage.setItem(TOKEN_KEY, data.access_token);
      await loadCurrentUser();
      await refreshPosts();
      showToast('Sesi√≥n iniciada');
    } catch (err) {
      showToast(err.message);
    }
  }

  function logout() {
    localStorage.removeItem(TOKEN_KEY);
    currentUser = null;
    updateAuthUi();
    showToast('Sesi√≥n cerrada');
  }

  async function loadCurrentUser() {
    if (!getToken()) {
      currentUser = null;
      return updateAuthUi();
    }
    try {
      currentUser = await api('/api/users/me');
    } catch {
      currentUser = null;
      localStorage.removeItem(TOKEN_KEY);
    }
    updateAuthUi();
  }

  function updateAuthUi() {
    const status = document.getElementById('authStatus');
    const name = currentUser ? currentUser.username : 'Tu Nombre';
    status.textContent = currentUser ? `Conectado como ${currentUser.username}` : 'No autenticado';
    document.querySelector('.sidebar-username').textContent = name;
    document.querySelector('.sidebar-handle').textContent = currentUser ? `@${currentUser.username}` : '@tunombre';
    document.querySelectorAll('.sidebar-avatar, .header-avatar, .composer-avatar').forEach(el => {
      el.textContent = name.slice(0, 1).toUpperCase();
    });
  }

  function handleImageFile(file) {
    const reader = new FileReader();
    reader.onload = e => {
      currentImageData = e.target.result;
      imagePreview.src = currentImageData;
      imagePreviewWrap.style.display = 'block';
      imageUploadZone.style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  function removeImage() {
    currentImageData = null;
    imageInput.value = '';
    imagePreviewWrap.style.display = 'none';
    imageUploadZone.style.display = 'block';
  }

  function toggleMenu(id, e) {
    e.stopPropagation();
    if (openMenuId === id) return closeMenus();
    closeMenus();
    openMenuId = id;
    document.getElementById('menu-' + id).style.display = 'block';
  }
  function closeMenus() {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
    openMenuId = null;
  }
  document.addEventListener('click', closeMenus);

  function timeAgo(isoString) {
    const diff = (Date.now() - new Date(isoString)) / 1000;
    if (diff < 60) return 'Ahora mismo';
    if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
    if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} h`;
    return new Date(isoString).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
  }

  function openModal(src) {
    document.getElementById('modalImg').src = src;
    document.getElementById('imgModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    document.getElementById('imgModal').style.display = 'none';
    document.body.style.overflow = '';
  }

  function renderFeed() {
    const feed = document.getElementById('feed');
    if (!posts.length) {
      feed.innerHTML = `<div class="empty-state"><div class="empty-icon">‚úèÔ∏è</div><div class="empty-title">Nada que mostrar a√∫n</div><p>Crea un post desde el compositor.</p></div>`;
      return;
    }

    feed.innerHTML = posts.map((post, i) => {
      const isLiked = !!likes[post.id];
      const initials = post.author.slice(0, 2).toUpperCase();
      const canDelete = currentUser && currentUser.id === post.owner_id;
      return `<article class="post-card" style="animation-delay:${Math.min(i,5)*0.05}s">
        <div class="post-header">
          <div class="post-avatar">${initials}</div>
          <div class="post-meta"><div class="post-author">${escHtml(post.author)}</div><div class="post-time">${timeAgo(post.timestamp)}</div></div>
          <div class="post-menu-wrap" onclick="event.stopPropagation()">
            <button class="post-menu-btn" onclick="toggleMenu('${post.id}', event)">‚ãØ</button>
            <div class="dropdown-menu" id="menu-${post.id}" style="display:none">
              <button class="dropdown-item" onclick="copyText('${post.id}')">üìã Copiar texto</button>
              ${canDelete ? `<button class="dropdown-item danger" onclick="deletePost('${post.id}')">üóëÔ∏è Eliminar</button>` : ''}
            </div>
          </div>
        </div>
        <div class="post-body">${post.text ? `<p class="post-text">${escHtml(post.text)}</p>` : ''}${post.image ? `<img src="${post.image}" class="post-image" alt="Imagen del post" onclick="openModal(this.src)" loading="lazy" />` : ''}</div>
        <div class="post-actions">
          <button id="likeBtn-${post.id}" class="action-btn${isLiked ? ' liked' : ''}" onclick="toggleLike('${post.id}')">‚ù§ <span class="like-count" id="likeCnt-${post.id}">${isLiked ? '1' : ''}</span></button>
          <button class="action-btn" onclick="copyText('${post.id}')">Comentar</button>
          <button class="action-btn" onclick="sharePost('${post.id}')">Compartir</button>
        </div>
      </article>`;
    }).join('');
  }

  function escHtml(str) {
    return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
  function copyText(id) {
    const post = posts.find(p => String(p.id) === String(id));
    if (post?.text) navigator.clipboard.writeText(post.text).then(() => showToast('Texto copiado'));
    closeMenus();
  }
  function sharePost() { showToast('Enlace copiado al portapapeles (simulado)'); }

  function updateStats() {
    const count = posts.length;
    const withImg = posts.filter(p => p.image).length;
    const totalLikes = Object.values(likes).filter(Boolean).length;
    document.getElementById('statPosts').textContent = count;
    document.getElementById('statWithImg').textContent = withImg;
    document.getElementById('statLikes').textContent = totalLikes;
    document.getElementById('headerCount').textContent = count + (count === 1 ? ' post' : ' posts');
  }

  function showToast(msg) {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2600);
  }

  (async function init() {
    await loadCurrentUser();
    try { await refreshPosts(); } catch { showToast('No se pudo cargar /api/posts'); }
  })();
</script>
</body>
</html>